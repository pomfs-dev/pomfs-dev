<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>수집 데이터 검토 - P.O.MFS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        .posts-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .posts-table th, .posts-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .posts-table th {
            background-color: #1a1a2e;
            color: #00ffff;
        }
        .posts-table tr:hover {
            background-color: #16213e;
        }
        .caption-cell {
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .post-link {
            color: #00ffff;
            text-decoration: none;
        }
        .post-link:hover {
            text-decoration: underline;
        }
        .stats-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .stat-box h3 {
            color: #00ffff;
            margin: 0;
            font-size: 2em;
        }
        .stat-box p {
            color: #888;
            margin: 5px 0 0 0;
        }
        .filter-form {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filter-form label {
            white-space: nowrap;
            color: #888;
        }
        .filter-form input, .filter-form select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #333;
            background: #1a1a2e;
            color: white;
            min-width: 120px;
        }
        .delete-all-btn {
            margin-left: auto;
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }
        .delete-all-btn:hover {
            background-color: #c82333;
        }
        .upload-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            white-space: nowrap;
        }
        .upload-btn:hover {
            background-color: #218838;
        }
        .upload-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        .checkbox-cell {
            width: 40px;
            text-align: center;
        }
        .checkbox-cell input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .img-thumb {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .img-thumb:hover {
            transform: scale(1.1);
        }
        .location-cell {
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .country-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
        }
        .country-kr { background: rgba(0, 123, 255, 0.2); color: #58a6ff; }
        .country-jp { background: rgba(255, 99, 132, 0.2); color: #ff6b6b; }
        .country-us { background: rgba(75, 192, 192, 0.2); color: #4bc0c0; }
        .country-other { background: rgba(153, 102, 255, 0.2); color: #9966ff; }
        /* Table responsive wrapper */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .posts-table {
            min-width: 900px;
        }
        /* Mobile Styles */
        @media (max-width: 768px) {
            .stats-summary {
                flex-direction: column;
                gap: 10px;
            }
            .stat-box {
                padding: 15px;
            }
            .stat-box h3 {
                font-size: 1.8em;
            }
            .filter-form {
                flex-direction: column;
                align-items: stretch;
            }
            .filter-form label {
                margin-bottom: 5px;
            }
            .filter-form select {
                width: 100%;
            }
            .action-buttons {
                flex-direction: column;
                width: 100%;
            }
            .action-buttons button {
                width: 100%;
            }
            .posts-table th, .posts-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
            .img-thumb {
                width: 40px;
                height: 40px;
            }
        }
        /* Modal for image preview */
        .img-modal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
        }
        .img-modal img {
            max-width: 90%;
            max-height: 90%;
            margin: auto;
            display: block;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        .img-modal-close {
            position: absolute;
            top: 20px;
            right: 30px;
            color: #fff;
            font-size: 40px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header>
        <h1>최종 수집 데이터 검토</h1>
        <nav>
            <a href="/" class="btn"
                style="background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color);">대시보드</a>
            <a href="/scrape" class="btn">새 공연 수집</a>
            <a href="/events" class="btn">등록 정보 확인</a>
        </nav>
    </header>

    <main class="container" style="padding: 20px;">
        <div class="stats-summary">
            <div class="stat-box">
                <h3>{{ posts|length }}</h3>
                <p>수집된 포스트</p>
            </div>
            <div class="stat-box">
                <h3>{{ usernames|length }}</h3>
                <p>수집된 계정</p>
            </div>
        </div>

        <form class="filter-form" method="get" action="/review">
            <label for="username">계정 필터:</label>
            <select name="username" id="username" onchange="this.form.submit()">
                <option value="">전체</option>
                {% for u in usernames %}
                <option value="{{ u }}" {% if u == selected_username %}selected{% endif %}>{{ u }}</option>
                {% endfor %}
            </select>
            <label for="limit">표시 개수:</label>
            <select name="limit" id="limit" onchange="this.form.submit()">
                <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
                <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
                <option value="200" {% if limit == 200 %}selected{% endif %}>200</option>
                <option value="500" {% if limit == 500 %}selected{% endif %}>500</option>
                <option value="0" {% if limit == 0 %}selected{% endif %}>전체</option>
            </select>
            <div class="action-buttons">
                <button type="button" onclick="uploadSelectedToDevDB()" class="upload-btn" id="uploadBtn" disabled>
                    선택 항목 DB 업로드
                </button>
                <button type="button" onclick="deleteAllPosts()" class="delete-all-btn">
                    전체 삭제
                </button>
            </div>
        </form>

        <script>
        function deleteAllPosts() {
            if (!confirm('정말로 수집된 모든 포스트를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                return;
            }
            
            fetch('/api/review/delete-all-scraped', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        alert(`${data.deleted}개의 포스트가 삭제되었습니다.`);
                        location.reload();
                    } else {
                        alert('삭제 오류: ' + data.error);
                    }
                })
                .catch(err => alert('오류: ' + err));
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.post-checkbox');
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateUploadButton();
        }

        function updateUploadButton() {
            const checkboxes = document.querySelectorAll('.post-checkbox:checked');
            const btn = document.getElementById('uploadBtn');
            btn.disabled = checkboxes.length === 0;
            btn.textContent = checkboxes.length > 0 
                ? `선택 항목 DB 업로드 (${checkboxes.length}개)`
                : '선택 항목 DB 업로드';
        }

        async function uploadSelectedToDevDB() {
            const checkboxes = document.querySelectorAll('.post-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (ids.length === 0) {
                alert('업로드할 항목을 선택해주세요.');
                return;
            }
            
            if (!confirm(`선택한 ${ids.length}개의 항목을 MusicFeedPlatform Development DB에 업로드하시겠습니까?`)) {
                return;
            }
            
            const btn = document.getElementById('uploadBtn');
            btn.disabled = true;
            
            const BATCH_SIZE = 100;
            let totalUploaded = 0;
            let totalSkipped = 0;
            let errors = [];
            
            try {
                for (let i = 0; i < ids.length; i += BATCH_SIZE) {
                    const batch = ids.slice(i, i + BATCH_SIZE);
                    const batchNum = Math.floor(i / BATCH_SIZE) + 1;
                    const totalBatches = Math.ceil(ids.length / BATCH_SIZE);
                    
                    btn.textContent = `업로드 중... (${batchNum}/${totalBatches})`;
                    
                    try {
                        const response = await fetch('/api/review/upload-to-dev-db', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ ids: batch })
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            totalUploaded += data.uploaded || 0;
                            totalSkipped += data.skipped || 0;
                        } else {
                            errors.push(`배치 ${batchNum}: ${data.error}`);
                        }
                    } catch (err) {
                        errors.push(`배치 ${batchNum}: ${err.message}`);
                    }
                }
                
                let message = `${totalUploaded}개의 항목이 MusicFeedPlatform DB에 업로드되었습니다.\n(${totalSkipped}개 중복 건너뜀)`;
                if (errors.length > 0) {
                    message += `\n\n오류 발생: ${errors.length}개 배치\n` + errors.slice(0, 3).join('\n');
                }
                alert(message);
                location.reload();
            } catch (err) {
                alert('통신 오류: ' + err);
            } finally {
                btn.disabled = false;
                updateUploadButton();
            }
        }
        </script>

        <div class="table-responsive">
        <table class="posts-table">
            <thead>
                <tr>
                    <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th>이미지</th>
                    <th>ID</th>
                    <th>계정</th>
                    <th>이벤트명</th>
                    <th>공연장</th>
                    <th>주소</th>
                    <th>국가</th>
                    <th>날짜</th>
                    <th>아티스트</th>
                    <th>수집일</th>
                    <th>링크</th>
                </tr>
            </thead>
            <tbody>
                {% for post in posts %}
                <tr>
                    <td class="checkbox-cell"><input type="checkbox" class="post-checkbox" value="{{ post.id }}" onchange="updateUploadButton()"></td>
                    <td>
                        {% if post.local_image_path %}
                        <img src="/{{ post.local_image_path }}" class="img-thumb" onclick="openImageModal('/{{ post.local_image_path }}')" alt="preview">
                        {% elif post.image_url %}
                        <img src="{{ post.image_url }}" class="img-thumb" onclick="openImageModal('{{ post.image_url }}')" alt="preview">
                        {% else %}
                        <span style="color:#666;">-</span>
                        {% endif %}
                    </td>
                    <td>{{ post.id }}</td>
                    <td>{{ post.source_username or '-' }}</td>
                    <td class="caption-cell" title="{{ post.event_name or post.content }}">{{ (post.event_name or post.content or '-')[:40] }}{% if (post.event_name or post.content or '')|length > 40 %}...{% endif %}</td>
                    <td>{{ post.event_venue or '-' }}</td>
                    <td class="location-cell" title="{{ post.event_location or '' }}">{{ (post.event_location or '-')[:20] }}{% if (post.event_location or '')|length > 20 %}...{% endif %}</td>
                    <td>
                        {% set country = post.event_country or '' %}
                        {% if country == 'KR' %}
                        <span class="country-badge country-kr">KR</span>
                        {% elif country == 'JP' %}
                        <span class="country-badge country-jp">JP</span>
                        {% elif country == 'US' %}
                        <span class="country-badge country-us">US</span>
                        {% elif country %}
                        <span class="country-badge country-other">{{ country }}</span>
                        {% else %}
                        <span style="color:#666;">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if post.event_dates %}
                            {% set dates = post.event_dates %}
                            {{ dates[0]['date'] if dates else '-' }}
                        {% elif post.event_date %}
                            {{ post.event_date.strftime('%Y-%m-%d') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>{{ (post.performing_artists|join(', ') if post.performing_artists else '-')[:20] }}</td>
                    <td>{{ post.created_at.strftime('%Y-%m-%d') if post.created_at else '-' }}</td>
                    <td>
                        {% if post.post_url %}
                        <a href="{{ post.post_url }}" target="_blank" class="post-link">보기</a>
                        {% else %}
                        -
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                {% if not posts %}
                <tr>
                    <td colspan="12" style="text-align: center; color: #888;">수집된 포스트가 없습니다.</td>
                </tr>
                {% endif %}
            </tbody>
        </table>
        </div>

        <!-- Image Preview Modal -->
        <div id="imageModal" class="img-modal" onclick="closeImageModal()">
            <span class="img-modal-close" onclick="event.stopPropagation(); closeImageModal();">&times;</span>
            <img id="modalImage" src="" onclick="event.stopPropagation();">
        </div>

        <script>
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').style.display = 'block';
        }
        function closeImageModal() {
            document.getElementById('imageModal').style.display = 'none';
        }
        </script>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>
