<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê³µì—° ì •ë³´ ìˆ˜ì§‘ : P.O.MFS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-color: #0d1117;
            --card-bg: #161b22;
            --text-color: #c9d1d9;
            --text-muted: #8b949e;
            --border-color: #30363d;
            --accent-color: #58a6ff;
            --success-color: #3fb950;
            --warning-color: #d29922;
            --error-color: #f85149;
        }
        
        body {
            font-family: 'Apple SD Gothic Neo', -apple-system, BlinkMacSystemFont, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .container {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"] {
            padding: 12px;
            width: 100%;
            background-color: #21262d;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            color: var(--text-color);
            font-size: 14px;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.3);
        }

        .btn-primary {
            padding: 14px 24px;
            background: linear-gradient(135deg, var(--accent-color), #1f6feb);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(88, 166, 255, 0.4);
        }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 14px;
        }

        .back-link:hover {
            color: var(--accent-color);
        }

        h2 {
            margin-bottom: 8px;
            color: #fff;
        }

        .subtitle {
            color: var(--text-muted);
            margin-bottom: 24px;
        }

        .progress-container {
            width: 100%;
            background-color: #21262d;
            border-radius: 8px;
            overflow: hidden;
            height: 28px;
            border: 1px solid var(--border-color);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-color), var(--success-color));
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 12px;
            color: #fff;
        }

        .log-terminal {
            background-color: #0d1117;
            color: #39d353;
            padding: 16px;
            border-radius: 8px;
            font-family: 'Fira Code', 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .log-entry {
            margin-bottom: 4px;
            line-height: 1.5;
        }

        .log-time {
            color: #6e7681;
        }

        .log-info { color: #39d353; }
        .log-error { color: #f85149; }
        .log-warning { color: #d29922; }
        .log-success { color: #3fb950; }
        .log-api { color: #58a6ff; }

        .result-card {
            background: linear-gradient(135deg, #21262d, #161b22);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .result-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-box {
            flex: 1;
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-box.saved {
            background: rgba(63, 185, 80, 0.15);
            border: 1px solid rgba(63, 185, 80, 0.3);
        }

        .stat-box.skipped {
            background: rgba(139, 148, 158, 0.15);
            border: 1px solid rgba(139, 148, 158, 0.3);
        }

        .stat-box.total {
            background: rgba(88, 166, 255, 0.15);
            border: 1px solid rgba(88, 166, 255, 0.3);
        }

        .stat-number {
            font-size: 2em;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.85em;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .details-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 12px;
            background: rgba(255,255,255,0.03);
            border-radius: 6px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .detail-name {
            color: var(--text-color);
            font-weight: 500;
        }

        .detail-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-saved {
            background: rgba(63, 185, 80, 0.2);
            color: var(--success-color);
        }

        .status-skipped {
            background: rgba(139, 148, 158, 0.2);
            color: var(--text-muted);
        }

        .status-duplicate {
            background: rgba(210, 153, 34, 0.2);
            color: var(--warning-color);
        }

        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .btn-success {
            flex: 1;
            padding: 14px;
            background: linear-gradient(135deg, var(--success-color), #238636);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary {
            flex: 1;
            padding: 14px;
            background: #21262d;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-secondary:hover {
            background: #30363d;
        }
    </style>
</head>

<body>
    <a href="/" class="back-link">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>

    <div class="container">
        <h2>ğŸš€ ì¸ìŠ¤íƒ€ê·¸ë¨ ê³µì—° ì •ë³´ ìˆ˜ì§‘</h2>
        <p class="subtitle">íƒ€ê²Ÿ ê³„ì •ì˜ ìµœì‹  ê²Œì‹œë¬¼ì„ ìˆ˜ì§‘í•˜ê³  AIê°€ ê³µì—° ì •ë³´ë¥¼ ìë™ ë¶„ì„í•©ë‹ˆë‹¤.</p>

        <div id="input-section">
            <form id="scrape-form" onsubmit="startScrape(event)">
                <div class="form-group">
                    <label for="username">ì¸ìŠ¤íƒ€ê·¸ë¨ ID ë˜ëŠ” ì£¼ì†Œ</label>
                    <input type="text" name="username" id="username"
                        placeholder="ì˜ˆ: p.o.mfs ë˜ëŠ” https://instagram.com/p.o.mfs" required>
                </div>

                <div class="form-group">
                    <label for="limit">ìˆ˜ì§‘í•  ê²Œì‹œë¬¼ ìˆ˜</label>
                    <input type="number" name="limit" id="limit" value="3" min="1" max="10">
                </div>

                <button type="submit" class="btn-primary">ğŸ” ìˆ˜ì§‘ ë° ë¶„ì„ ì‹œì‘</button>
            </form>
        </div>

        <div id="progress-section" style="display:none;">
            <h3 style="text-align: center; margin-bottom: 8px;">ğŸ”„ ìˆ˜ì§‘ ë° ë¶„ì„ ì§„í–‰ ì¤‘...</h3>
            <p id="progress-message" style="text-align: center; color: var(--text-muted); margin-bottom: 16px;">ì´ˆê¸°í™” ì¤‘ì…ë‹ˆë‹¤...</p>
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar" style="width: 0%;">
                    <span id="progress-percent">0%</span>
                </div>
            </div>
            
            <div style="margin-top: 24px;">
                <h5 style="margin-bottom: 12px; color: var(--text-color); font-size: 14px;">ğŸ“‹ ì‘ì—… ë¡œê·¸</h5>
                <div id="log-container" class="log-terminal"></div>
            </div>
        </div>

        <div id="result-section" style="display:none;">
            <div class="result-card">
                <h3 style="margin-bottom: 16px; text-align: center;">âœ… ìˆ˜ì§‘ ì™„ë£Œ!</h3>
                
                <div class="result-stats">
                    <div class="stat-box saved">
                        <div class="stat-number" id="result-saved" style="color: var(--success-color);">0</div>
                        <div class="stat-label">ì €ì¥ë¨</div>
                    </div>
                    <div class="stat-box skipped">
                        <div class="stat-number" id="result-skipped" style="color: var(--text-muted);">0</div>
                        <div class="stat-label">Skip (ë¹„ê³µì—°)</div>
                    </div>
                    <div class="stat-box total">
                        <div class="stat-number" id="result-total" style="color: var(--accent-color);">0</div>
                        <div class="stat-label">ì´ ìˆ˜ì§‘</div>
                    </div>
                </div>

                <div id="details-section">
                    <h5 style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">ğŸ“ ìƒì„¸ ë‚´ì—­</h5>
                    <div id="details-list" class="details-list"></div>
                </div>

                <div class="action-buttons">
                    <button class="btn-success" onclick="goToReview()">ğŸ“‹ ë“±ë¡ ì´ë²¤íŠ¸ í™•ì¸</button>
                    <button class="btn-secondary" onclick="resetForm()">ğŸ”„ ë‹¤ì‹œ ìˆ˜ì§‘</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentUsername = '';

        window.onload = function () {
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username');
            const auto = urlParams.get('auto');

            if (username) {
                document.getElementById('username').value = username;
                if (auto === 'true') {
                    setTimeout(() => {
                        startScrape(null);
                    }, 500);
                }
            }
        };

        function startScrape(event) {
            if (event) event.preventDefault();

            currentUsername = document.getElementById('username').value;
            const limit = document.getElementById('limit').value;

            document.getElementById('input-section').style.display = 'none';
            document.getElementById('progress-section').style.display = 'block';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('log-container').innerHTML = '';

            const source = new EventSource(`/scrape_stream?username=${encodeURIComponent(currentUsername)}&limit=${limit}`);
            let isCompleted = false;

            source.onmessage = function (event) {
                const data = JSON.parse(event.data);

                if (data.error) {
                    addLog('ERROR: ' + data.error, 'error');
                    source.close();
                    setTimeout(() => {
                        alert('ì˜¤ë¥˜ ë°œìƒ: ' + data.error);
                        resetForm();
                    }, 1000);
                    return;
                }

                if (data.progress !== undefined) {
                    const pct = data.progress;
                    document.getElementById('progress-bar').style.width = pct + '%';
                    document.getElementById('progress-percent').innerText = pct + '%';
                }

                if (data.message) {
                    document.getElementById('progress-message').innerText = data.message;
                    addLog(data.message, 'info');
                }
                
                if (data.log) {
                    addLog(data.log, data.log_type || 'info');
                }

                if (data.complete) {
                    isCompleted = true;
                    source.close();
                    addLog('ğŸ‰ ë¶„ì„ ì™„ë£Œ! ê²°ê³¼ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤...', 'success');
                    
                    setTimeout(() => {
                        showResults(data);
                    }, 500);
                }
            };

            source.onerror = function (err) {
                console.error("EventSource failed:", err);
                source.close();
                if (!isCompleted) {
                    addLog('ì„œë²„ ì—°ê²° ì˜¤ë¥˜ ë°œìƒ', 'error');
                    setTimeout(() => {
                        alert('ì„œë²„ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                        resetForm();
                    }, 1000);
                }
            };
        }
        
        function addLog(message, type) {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString('ko-KR');
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            
            const colorClass = `log-${type}`;
            logEntry.innerHTML = `<span class="log-time">[${timestamp}]</span> <span class="${colorClass}">${message}</span>`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function showResults(data) {
            const savedCount = data.saved_count || 0;
            const skipCount = data.skip_count || 0;
            const scrapedCount = data.scraped_count || 0;
            const details = data.details || [];

            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'block';

            document.getElementById('result-saved').innerText = savedCount;
            document.getElementById('result-skipped').innerText = skipCount;
            document.getElementById('result-total').innerText = scrapedCount;

            const detailsList = document.getElementById('details-list');
            detailsList.innerHTML = '';

            if (details.length === 0) {
                detailsList.innerHTML = '<div class="detail-item"><span class="detail-name" style="color: var(--text-muted);">ìˆ˜ì§‘ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</span></div>';
            } else {
                details.forEach(item => {
                    const name = item.event_name || item.shortcode || '(ì œëª© ì—†ìŒ)';
                    const status = item.db_status || 'Unknown';
                    
                    let statusClass = 'status-skipped';
                    let statusText = status;
                    
                    if (status === 'Saved') {
                        statusClass = 'status-saved';
                        statusText = 'âœ… ì €ì¥ë¨';
                    } else if (status === 'Duplicate') {
                        statusClass = 'status-duplicate';
                        statusText = 'âš ï¸ ì¤‘ë³µ';
                    } else if (status.startsWith('Skipped')) {
                        statusClass = 'status-skipped';
                        statusText = 'â­ï¸ Skip';
                    }

                    const itemHtml = `
                        <div class="detail-item">
                            <span class="detail-name">${escapeHtml(name)}</span>
                            <span class="detail-status ${statusClass}">${statusText}</span>
                        </div>
                    `;
                    detailsList.innerHTML += itemHtml;
                });
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function goToReview() {
            window.location.href = '/review';
        }

        function resetForm() {
            document.getElementById('input-section').style.display = 'block';
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('result-section').style.display = 'none';
            document.getElementById('log-container').innerHTML = '';
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('progress-percent').innerText = '0%';
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% include 'components/developer_log.html' %}
</body>

</html>
