<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>등록된 공연 정보 - P.O.MFS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        .events-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .events-table th, .events-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #333;
        }
        .events-table th {
            background-color: #1a1a2e;
            color: #00ffff;
        }
        .events-table tr:hover {
            background-color: #16213e;
        }
        .content-cell {
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .stats-summary {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid #333;
        }
        .stat-box h3 {
            color: #00ffff;
            margin: 0;
            font-size: 2em;
        }
        .stat-box p {
            color: #888;
            margin: 5px 0 0 0;
        }
        .draft-badge {
            background-color: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .published-badge {
            background-color: #28a745;
            color: #fff;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
        }
        .artist-tag {
            background-color: #6f42c1;
            color: #fff;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.75em;
            margin-right: 4px;
        }
        /* Table responsive wrapper */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        /* Mobile Styles */
        @media (max-width: 768px) {
            .stats-summary {
                flex-direction: column;
                gap: 10px;
            }
            .stat-box {
                padding: 15px;
            }
            .stat-box h3 {
                font-size: 1.8em;
            }
            .events-table {
                min-width: 700px;
            }
            .events-table th, .events-table td {
                padding: 10px 8px;
                font-size: 0.85rem;
            }
            .action-buttons-container {
                flex-direction: column;
                gap: 8px;
            }
        }
    </style>
</head>

<body>
    <header>
        <h1>등록된 공연 정보</h1>
        <nav>
            <a href="/" class="btn"
                style="background-color: transparent; border: 1px solid var(--accent-color); color: var(--accent-color);">대시보드</a>
            <a href="/review" class="btn">수집 데이터 검토</a>
        </nav>
    </header>

    <main class="container" style="padding: 20px;">
        <div class="stats-summary">
            <div class="stat-box">
                <h3>{{ events|length }}</h3>
                <p>총 등록 공연</p>
            </div>
            <div class="stat-box">
                <h3>{{ events|selectattr('is_draft')|list|length }}</h3>
                <p>임시저장 (Draft)</p>
            </div>
            <div class="stat-box">
                <h3>{{ events|rejectattr('is_draft')|list|length }}</h3>
                <p>게시됨</p>
            </div>
        </div>

        <p style="color: #888; margin-bottom: 20px;">MusicFeedPlatform Development DB에 저장된 모든 공연 정보입니다.</p>

        <div class="action-buttons-container" style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 10px;">
            <button id="publishBtn" class="btn" style="background-color: #28a745;" onclick="publishSelected()" disabled>
                선택 항목 게시
            </button>
            <button id="deleteBtn" class="btn" style="background-color: #dc3545;" onclick="deleteSelected()" disabled>
                선택 항목 삭제
            </button>
            <span id="selectedCount" style="color: #888; align-self: center;"></span>
        </div>

        {% if events %}
        <div class="table-responsive">
        <table class="events-table">
            <thead>
                <tr>
                    <th style="width: 40px;">
                        <input type="checkbox" id="selectAll" onchange="toggleAll()" title="모든 항목 선택">
                    </th>
                    <th>ID</th>
                    <th>공연명</th>
                    <th>공연장</th>
                    <th>날짜</th>
                    <th>아티스트</th>
                    <th>상태</th>
                    <th>등록일</th>
                </tr>
            </thead>
            <tbody>
                {% for event in events %}
                <tr>
                    <td>
                        <input type="checkbox" class="event-checkbox" data-id="{{ event.id }}" data-is-draft="{{ event.is_draft }}" onchange="updateSelectionButtons()">
                    </td>
                    <td>{{ event.id }}</td>
                    <td>{{ event.event_name or '-' }}</td>
                    <td>{{ event.venue_name or '-' }}</td>
                    <td>
                        {% if event.event_dates %}
                            {% if event.event_dates is iterable and event.event_dates is not string %}
                                {% for d in event.event_dates[:3] %}
                                    {{ d.date if d.date else d }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                {% if event.event_dates|length > 3 %}...{% endif %}
                            {% else %}
                                {{ event.event_dates }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if event.performing_artists %}
                            {% if event.performing_artists is iterable and event.performing_artists is not string %}
                                {% for artist in event.performing_artists[:3] %}
                                    <span class="artist-tag">{{ artist }}</span>
                                {% endfor %}
                                {% if event.performing_artists|length > 3 %}...{% endif %}
                            {% else %}
                                {{ event.performing_artists }}
                            {% endif %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if event.is_draft %}
                            <span class="draft-badge">임시저장</span>
                        {% else %}
                            <span class="published-badge">게시됨</span>
                        {% endif %}
                    </td>
                    <td>{{ event.created_at.strftime('%Y-%m-%d') if event.created_at else '-' }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; color: #888;">
            <p>등록된 공연 정보가 없습니다.</p>
            <p>수집된 데이터를 검토 후 DB에 저장하면 이곳에 표시됩니다.</p>
        </div>
        {% endif %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function updateSelectionButtons() {
            const allChecked = document.querySelectorAll('.event-checkbox:checked');
            const draftChecked = Array.from(allChecked).filter(cb => cb.dataset.isDraft === 'True');
            const publishBtn = document.getElementById('publishBtn');
            const deleteBtn = document.getElementById('deleteBtn');
            const countSpan = document.getElementById('selectedCount');
            
            publishBtn.disabled = draftChecked.length === 0;
            deleteBtn.disabled = allChecked.length === 0;
            countSpan.textContent = allChecked.length > 0 ? `${allChecked.length}개 선택됨` : '';
        }
        
        function toggleAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.event-checkbox');
            
            checkboxes.forEach(cb => cb.checked = selectAll.checked);
            updateSelectionButtons();
        }
        
        async function publishSelected() {
            const allChecked = document.querySelectorAll('.event-checkbox:checked');
            const draftChecked = Array.from(allChecked).filter(cb => cb.dataset.isDraft === 'True');
            const ids = draftChecked.map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('게시할 항목을 선택해주세요.');
                return;
            }
            
            if (!confirm(`${ids.length}개의 항목을 게시하시겠습니까?`)) {
                return;
            }
            
            const btn = document.getElementById('publishBtn');
            btn.disabled = true;
            btn.textContent = '게시 중...';
            
            try {
                const response = await fetch('/api/registered/publish', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`${result.published}개의 항목이 게시되었습니다.`);
                    window.location.reload();
                } else {
                    alert('게시 중 오류가 발생했습니다: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                alert('게시 중 오류가 발생했습니다: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '선택 항목 게시';
                updateSelectionButtons();
            }
        }
        
        async function deleteSelected() {
            const checkboxes = document.querySelectorAll('.event-checkbox:checked');
            const ids = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
            
            if (ids.length === 0) {
                alert('삭제할 항목을 선택해주세요.');
                return;
            }
            
            if (!confirm(`${ids.length}개의 항목을 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.`)) {
                return;
            }
            
            const btn = document.getElementById('deleteBtn');
            btn.disabled = true;
            btn.textContent = '삭제 중...';
            
            try {
                const response = await fetch('/api/registered/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`${result.deleted}개의 항목이 삭제되었습니다.`);
                    window.location.reload();
                } else {
                    alert('삭제 중 오류가 발생했습니다: ' + (result.error || '알 수 없는 오류'));
                }
            } catch (error) {
                alert('삭제 중 오류가 발생했습니다: ' + error.message);
            } finally {
                btn.disabled = false;
                btn.textContent = '선택 항목 삭제';
                updateSelectionButtons();
            }
        }
    </script>
</body>

</html>
