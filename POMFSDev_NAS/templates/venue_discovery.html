<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ê³µì—°ì¥ ì¸ìŠ¤íƒ€ ì°¾ê¸° : P.O.MFS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Outfit:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .pagination a {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            text-decoration: none;
            color: var(--text-color);
        }

        .pagination a.active {
            background-color: var(--accent-color);
            color: #fff;
            border-color: var(--accent-color);
        }

        .search-btn {
            padding: 5px 10px;
            font-size: 0.8em;
            cursor: pointer;
        }

        .result-cell {
            font-weight: bold;
            color: var(--accent-color);
        }
    </style>
</head>

<body>
    <header>
        <h1>ğŸ” ê³µì—°ì¥ ì¸ìŠ¤íƒ€ê·¸ë¨ ì°¾ê¸°</h1>
        <nav>
            <a href="/" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œë¡œ ëŒì•„ê°€ê¸°</a>
        </nav>
    </header>

    <div class="card">
        <!-- File Upload Section -->
        <!-- File Upload Section -->
        <div
            style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px dashed #ccc; color: #333;">
            <form action="{{ url_for('venue_discovery') }}" method="post" enctype="multipart/form-data"
                style="display: flex; gap: 10px; align-items: center;">
                <span style="font-weight: bold;">ğŸ“‚ ì—‘ì…€ ë°ì´í„° ì—…ë¡œë“œ:</span>
                <input type="file" name="file" accept=".xlsx, .xls" required style="flex-grow: 1; color: #333;">
                <button type="submit" class="btn btn-primary">ì—…ë¡œë“œ ë° ë¶„ì„ ì‹œì‘</button>
            </form>
            <span>* ê¶Œì¥ ì»¬ëŸ¼: <code>venue_name, country, city, main_genre</code></span>
        </div>
    </div>

    <!-- Direct Keyword Search Section -->
    <style>
        /* Placeholder visibility fix */
        .manual-input::placeholder {
            color: #aaa !important;
            opacity: 1;
        }
    </style>
    <div style="background: #252525; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #444;">
        <h5 style="margin-bottom:15px; display:flex; align-items:center; gap:10px; color:#fff;">
            âš¡ í‚¤ì›Œë“œ ì§ì ‘ ê²€ìƒ‰ <span style="font-size:0.6em; color:#999; font-weight:normal;">(ì—‘ì…€ ì—†ì´ ë°”ë¡œ ì°¾ê¸°)</span>
        </h5>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <div style="flex: 2; min-width: 200px;">
                <label style="color:#ccc; font-size:0.8em; margin-bottom:5px; display:block;">ê³µì—°ì¥/í‚¤ì›Œë“œ (í•„ìˆ˜)</label>
                <input type="text" id="manual-venue-name" class="form-control manual-input" placeholder="ì˜ˆ: í™ëŒ€ í´ëŸ½"
                    style="background-color: #3b3b3b; color: #e0e0e0; border: 1px solid #555;">
            </div>
            <div style="flex: 1; min-width: 120px;">
                <label style="color:#ccc; font-size:0.8em; margin-bottom:5px; display:block;">ë„ì‹œ (ì„ íƒ)</label>
                <input type="text" id="manual-city" class="form-control manual-input" placeholder="Seoul"
                    style="background-color: #3b3b3b; color: #e0e0e0; border: 1px solid #555;">
            </div>
            <div style="flex: 1; min-width: 120px;">
                <label style="color:#ccc; font-size:0.8em; margin-bottom:5px; display:block;">êµ­ê°€ (ì„ íƒ)</label>
                <input type="text" id="manual-country" class="form-control manual-input" placeholder="Korea"
                    style="background-color: #3b3b3b; color: #e0e0e0; border: 1px solid #555;">
            </div>
            <div style="flex: 0 0 auto; min-width: 100px;">
                <label style="opacity:0; font-size:0.8em; margin-bottom:5px; display:block;">&nbsp;</label>
                <!-- Button aligns to bottom via flex-end -->
                <button class="btn btn-warning" onclick="manualSearchStart()"
                    style="height: 38px; font-weight: bold; color: #000; width: 100%; display: flex; align-items: center; justify-content: center;">
                    ğŸ” ê²€ìƒ‰ ì‹œì‘
                </button>
            </div>
        </div>

        <!-- Manual Result Area -->
        <div id="manual-search-result"
            style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px; display:none;">
            <div style="display:flex; align-items:center; gap:10px;">
                <span style="color:#aaa;">ê²°ê³¼:</span>
                <div id="result-manual" class="result-area" style="flex-grow:1;"></div>
            </div>
        </div>
    </div>

    <!-- Status Legend Guide -->
    <details
        style="margin-bottom: 20px; background: #252525; color: #e0e0e0; padding: 10px; border-radius: 5px; border: 1px solid #444;">
        <summary style="font-weight: bold; cursor: pointer; color: #fff;">â„¹ï¸ ìƒíƒœ ë©”ì‹œì§€ ë„ì›€ë§ (í´ë¦­í•˜ì—¬ ì—´ê¸°)</summary>
        <ul style="margin: 10px 0 0 20px; font-size: 0.9em; line-height: 1.6;">
            <li><span style="color:#aaa; font-weight:bold;">â„¹ï¸ ê²Œì‹œë¬¼ ì—†ìŒ</span>: ìµœê·¼ ê²Œì‹œë¬¼ì´ ì—†ê±°ë‚˜, ì´ë¯¸ì§€ ì—†ì´ ë™ì˜ìƒ(Reels)ë§Œ ìˆëŠ” ê²½ìš°ì…ë‹ˆë‹¤.
            </li>
            <li><span style="color:#ffc107; font-weight:bold;">âš ï¸ ì €ì¥ 0ê±´</span>: ì´ë¯¸ì§€ëŠ” ê°€ì ¸ì™”ìœ¼ë‚˜ AIê°€ 'ê³µì—° ì •ë³´'ë¥¼ ëª…í™•íˆ ì‹ë³„í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.
                (ë¶€ì •í™•í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ <strong>[ğŸ”ê²€í† ]</strong> ë²„íŠ¼ì„ ëˆŒëŸ¬ í™•ì¸í•˜ì„¸ìš”)</li>
            <li><span style="color:red; font-weight:bold;">âŒ ìµœì¢… ì‹¤íŒ¨</span>: ë„¤ì´ë²„/êµ¬ê¸€ ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ê±°ë‚˜, ê²€ìƒ‰ ì—”ì§„ì´ ì°¨ë‹¨(Captcha)ëœ ê²½ìš°ì…ë‹ˆë‹¤.
                (ì§ì ‘ ì…ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”)</li>
            <li><span style="color:#28a745; font-weight:bold;">âœ… Nê±´ ì €ì¥</span>: ì •ìƒì ìœ¼ë¡œ ë¶„ì„ë˜ì–´ ê³µì—° ì •ë³´ê°€ DBì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</li>
            <li><span style="color:#28a745; font-weight:bold;">ğŸ“¸ ìˆ˜ì§‘</span>: ì¸ìŠ¤íƒ€ê·¸ë¨ IDëŠ” ì°¾ì•˜ìœ¼ë‚˜ ì•„ì§ ìˆ˜ì§‘í•˜ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤. ë²„íŠ¼ì„ ëˆŒëŸ¬
                ìˆ˜ì§‘í•˜ì„¸ìš”.</li>
        </ul>
    </details>

    {% if no_file %}
    <div style="text-align: center; padding: 50px;">
        <h3>ğŸ‘† ë¨¼ì € ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.</h3>
        <p>ê³µì—°ì¥ ëª©ë¡ì´ ë‹´ê¸´ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ë©´ ìë™ìœ¼ë¡œ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤.</p>
    </div>
    {% else %}

    <!-- Progress Dashboard (Global) -->
    <div id="progress-dashboard"
        style="display:none; margin-bottom: 20px; border: 1px solid #ddd; padding: 15px; border-radius: 5px; background: #fff;">
        <h4>ğŸš€ ì „ì²´ ë°°ì¹˜ ì‘ì—… ì§„í–‰ ìƒí™©</h4>

        <!-- Global Progress Bar -->
        <div style="margin-bottom: 5px; font-weight: bold; font-size: 0.9em; color: #555;">
            ì „ì²´ ì§„í–‰ë¥ : <span id="global-progress-text">0/0</span>
        </div>
        <div style="background-color: #e9ecef; border-radius: 5px; overflow: hidden; margin-bottom: 15px;">
            <div id="global-progress-bar"
                style="width: 0%; height: 25px; background-color: #28a745; text-align: center; line-height: 25px; color: white; transition: width 0.5s;">
                0%</div>
        </div>

        <!-- Log Terminal -->
        <div id="log-terminal"
            style="background: #1e1e1e; color: #00ff00; padding: 10px; height: 150px; overflow-y: auto; font-family: monospace; font-size: 0.9em; border-radius: 5px; border: 1px solid #333;">
            <div style="color: #666;">ëŒ€ê¸° ì¤‘...</div>
        </div>
    </div>

    <div class="card mb-3">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: nowrap; gap: 20px;">
            <!-- Left: Info -->
            <div style="display: flex; flex-direction: column; justify-content: center;">
                <div style="white-space: nowrap; margin-bottom: 4px;">
                    ì „ì²´ <strong>{{ total_rows }}</strong>ê°œì˜ ê³µì—°ì¥ ì¤‘
                    <strong>{{ (page-1)*50 + 1 }} - {{ (page-1)*50 + rows|length }}</strong> í‘œì‹œ ì¤‘
                </div>
                <div style="font-size: 0.8em; color: #888;">
                    â„¹ï¸ ìŠ¬ë¼ì´ë”ë¥¼ ì¡°ì ˆí•˜ì—¬ ìë™í™” ì†ë„ë¥¼ ì œì–´í•˜ì„¸ìš”.
                </div>
            </div>

            <!-- Right: Controls -->
            <div style="display: flex; align-items: center; gap: 15px;">
                <!-- Process Flow Group -->
                <div
                    style="display: inline-flex; align-items: center; background: rgba(0,0,0,0.05); border-radius: 12px; border: 1px solid var(--border-color); padding: 5px 10px;">

                    <!-- Step 1: Batch Limit -->
                    <div style="display: flex; align-items: center; padding: 0 15px; border-right: 1px solid #ccc;">
                        <div style="display: flex; flex-direction: column; justify-content: center; gap: 3px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="scrape-limit"
                                    style="font-size: 0.85em; color: #555; margin: 0; line-height: 1.2;">1. ê²Œì‹œë¬¼
                                    ìˆ˜ì§‘</label>
                                <span id="scrape-limit-value"
                                    style="font-size: 1em; font-weight: bold; color: var(--accent-color); margin-left: 8px;">1</span>
                            </div>
                            <input type="range" class="form-range" id="scrape-limit" min="1" max="10" value="1"
                                autocomplete="off" style="width: 120px; height: 4px; padding: 0; margin: 0;">
                        </div>
                    </div>

                    <!-- Step 2: Concurrency -->
                    <div style="display: flex; align-items: center; padding: 0 15px;">
                        <div style="display: flex; flex-direction: column; justify-content: center; gap: 3px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <label for="concurrency-level"
                                    style="font-size: 0.85em; color: #555; margin: 0; line-height: 1.2;">2. ë™ì‹œ
                                    ì‘ì—…</label>
                                <span id="concurrency-value"
                                    style="font-size: 1em; font-weight: bold; color: var(--accent-color); margin-left: 8px;">1</span>
                            </div>
                            <input type="range" class="form-range" id="concurrency-level" min="1" max="5" value="1"
                                autocomplete="off" style="width: 120px; height: 4px; padding: 0; margin: 0;">
                        </div>
                    </div>

                    <!-- Step 3: Start Button -->
                    <div style="display: flex; align-items: center; padding-left: 5px;">
                        <button id="btn-start-all" class="btn btn-success" onclick="processAllOnPage()"
                            style="height: 48px; padding: 0 25px; font-weight: bold; font-size: 1.05em; display: flex; align-items: center; gap: 8px; border-radius: 8px; white-space: nowrap;">
                            ğŸš€ 3. ìë™ ê²€ìƒ‰ ì‹œì‘
                        </button>
                        <button id="btn-stop-all" class="btn btn-danger" onclick="stopSearch()"
                            style="display:none; height: 48px; padding: 0 25px; font-weight: bold; font-size: 1.05em; align-items: center; gap: 8px; border-radius: 8px; white-space: nowrap;">
                            â¹ï¸ ì¤‘ì§€
                        </button>
                    </div>
                </div>

                <!-- Admin Group -->
                <div
                    style="display: inline-flex; gap: 8px; align-items: center; margin-left: 10px; border-left: 1px solid #ccc; padding-left: 20px;">

                    <!-- Reset Excel File Button -->
                    <button class="btn btn-secondary" onclick="resetExcelFile()"
                        style="height: 44px; padding: 0 15px; font-size: 0.9em; display: flex; align-items: center; gap: 5px; border-radius: 8px; white-space: nowrap;">
                        ğŸ“‚ íŒŒì¼ ì´ˆê¸°í™”
                    </button>

                    <button class="btn btn-outline-danger" onclick="resetAllData()"
                        style="height: 44px; padding: 0 15px; font-size: 0.9em; display: flex; align-items: center; gap: 5px; border-radius: 8px; white-space: nowrap;">
                        ğŸ—‘ï¸ ë°ì´í„° ì´ˆê¸°í™”
                    </button>
                </div>
            </div>
        </div>
    </div>



    <table>
        <thead>
            <tr>
                <th style="width: 30%;">ê³µì—°ì¥ ì´ë¦„ (Venue)</th>
                <th style="width: 15%;">êµ­ê°€ (Country)</th>
                <th style="width: 15%;">ë„ì‹œ (City)</th>
                <th style="width: 15%;">ì¥ë¥´ (Genre)</th>
                <th style="width: 25%;">ì¸ìŠ¤íƒ€ê·¸ë¨ ID ì°¾ê¸°</th>
            </tr>
        </thead>
        <tbody>
            {% for row in rows %}
            <tr>
                <td>{{ row.venue_name }}</td>
                <td>{{ row.country }}</td>
                <td>{{ row.city }}</td>
                <td>{{ row.main_genre or '-' }}</td>
                <td>
                    <div id="result-{{ loop.index }}" class="result-area">
                        {% if row.instagram_id %}
                        <span class="result-cell">@{{ row.instagram_id }}</span>
                        <a href="https://instagram.com/{{ row.instagram_id }}" target="_blank"
                            style="font-size:0.8em; margin-left:5px; text-decoration:none;">ğŸ”—</a>
                        <a href="/scrape?username={{ row.instagram_id }}&auto=true" target="_blank"
                            class="btn btn-success" style="padding:2px 8px; font-size:0.8em; margin-left:5px;">ğŸ“¸
                            ìˆ˜ì§‘</a>
                        {% else %}
                        <button id="btn-{{ loop.index }}" class="btn btn-primary search-btn"
                            onclick="searchVenue('{{ row.venue_name }}', {{ loop.index }})">
                            ğŸ” ê²€ìƒ‰
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Pagination -->
    <div class="pagination">
        {% if page > 1 %}
        <a href="{{ url_for('venue_discovery', page=page-1) }}">&laquo; ì´ì „</a>
        {% endif %}

        <a href="#" class="active">{{ page }} / {{ total_pages }}</a>

        {% if page < total_pages %} <a href="{{ url_for('venue_discovery', page=page+1) }}">ë‹¤ìŒ &raquo;</a>
            {% endif %}
    </div>
    </div>
    {% endif %}

    <script>
        // Global variables for batch progress
        let globalTotalTasks = 0;
        let globalCompletedTasks = 0;

        function updateGlobalProgress(currentTaskPercent) {
            const bar = document.getElementById('global-progress-bar');
            const txt = document.getElementById('global-progress-text');

            if (!bar || !txt) return;

            const totalPoints = (globalTotalTasks > 0) ? globalTotalTasks * 100 : 1;
            const currentPoints = (globalCompletedTasks * 100) + currentTaskPercent;

            let pct = 0;
            if (globalTotalTasks > 0) {
                pct = Math.min(100, (currentPoints / totalPoints) * 100);
            }

            bar.style.width = `${pct}%`;
            bar.innerText = `${Math.round(pct)}%`;
            txt.innerText = `${globalCompletedTasks}/${globalTotalTasks} ì™„ë£Œ`;
        }

        let isSearching = false;
        let stopRequested = false;

        document.addEventListener('DOMContentLoaded', () => {
            const concurrencySlider = document.getElementById('concurrency-level');
            const concurrencyValue = document.getElementById('concurrency-value');
            if (concurrencySlider && concurrencyValue) {
                concurrencyValue.innerText = concurrencySlider.value;
                concurrencySlider.addEventListener('input', (e) => {
                    concurrencyValue.innerText = e.target.value;
                });
            }

            const scrapeLimitSlider = document.getElementById('scrape-limit');
            const scrapeLimitValue = document.getElementById('scrape-limit-value');
            if (scrapeLimitSlider && scrapeLimitValue) {
                scrapeLimitValue.innerText = scrapeLimitSlider.value;
                scrapeLimitSlider.addEventListener('input', (e) => {
                    scrapeLimitValue.innerText = e.target.value;
                });
            }
        });

        function manualSearchStart() {
            const name = document.getElementById('manual-venue-name').value.trim();
            const city = document.getElementById('manual-city').value.trim();
            const country = document.getElementById('manual-country').value.trim();

            if (!name) { alert('ê³µì—°ì¥ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

            document.getElementById('manual-search-result').style.display = 'block';
            searchVenue(name, 'manual', city, country);
        }

        function stopSearch() {
            if (isSearching) {
                stopRequested = true;
                const stopBtn = document.getElementById('btn-stop-all');
                stopBtn.innerText = "ğŸ›‘ ì¤‘ì§€ ì¤‘...";
                stopBtn.disabled = true;
            }
        }

        async function searchVenue(venueName, index, manualCity = '', manualCountry = '') {
            const resultDiv = document.getElementById(`result-${index}`);
            // UI Update
            resultDiv.innerHTML = '<span style="color:var(--accent-color);">â³ ê²€ìƒ‰ ì¤‘...</span>';

            try {
                const response = await fetch(`/api/search_venue?venue_name=${encodeURIComponent(venueName)}`);
                const data = await response.json();

                if (data.success) {
                    // Auto-Trigger Collection
                    return await autoCollect(venueName, data.instagram_id, index);
                } else {
                    // Not Found -> Auto Trigger Google Deep Search
                    let country = '', city = '';
                    if (index === 'manual') {
                        city = manualCity;
                        country = manualCountry;
                    } else {
                        const row = resultDiv.closest('tr');
                        if (row) {
                            country = row.cells[1].innerText;
                            city = row.cells[2].innerText;
                        }
                    }

                    resultDiv.innerHTML = '<span style="color:#4285F4; font-size:0.9em;">...Google ê²€ìƒ‰ ìë™ ì „í™˜ ğŸŒ</span>';

                    // Log to terminal
                    const term = document.getElementById('log-terminal');
                    if (term) {
                        term.innerHTML += `<div style="color: #aaa;">[Googleì „í™˜] ${venueName}</div>`;
                        term.scrollTop = term.scrollHeight;
                    }

                    // Call Google Search automatically
                    return await searchVenueGoogle(venueName, city, country, index);
                }
            } catch (error) {
                console.error('Error:', error);
                resultDiv.innerHTML = '<span style="color:red;">âš ï¸ ì˜¤ë¥˜</span>';
                return { status: 'error', message: error.toString() };
            }
        }

        async function searchVenueGoogle(venueName, city, country, index) {
            const resultDiv = document.getElementById(`result-${index}`);
            // resultDiv.innerHTML = '<span style="color:#4285F4;">ğŸŒ êµ¬ê¸€ ê²€ìƒ‰ ì¤‘ (5-10ì´ˆ)...</span>'; // Already set by caller usually

            try {
                const params = new URLSearchParams({
                    venue_name: venueName,
                    city: city,
                    country: country
                });
                const response = await fetch(`/api/search_venue_google?${params.toString()}`);
                const data = await response.json();

                if (data.success) {
                    // Auto-Trigger Collection
                    return await autoCollect(venueName, data.instagram_id, index);
                } else {
                    resultDiv.innerHTML = `
                        <span style="color:red; font-size:0.9em; margin-right:5px;">âŒ ìµœì¢… ì‹¤íŒ¨</span>
                        <button class="btn btn-dark" style="padding: 2px 8px; font-size: 0.8em; background-color: #666; border: none;" 
                            onclick="manualInput('${venueName}', ${index})">
                            âœï¸ ì§ì ‘ ì…ë ¥
                        </button>
                     `;
                    return { status: 'error', message: 'Not Found in Google' };
                }
            } catch (e) {
                resultDiv.innerHTML = '<span style="color:red;">âš ï¸ ì˜¤ë¥˜</span>';
                return { status: 'error', message: e.toString() };
            }
        }

        async function autoCollect(venueName, instagramId, index) {
            return new Promise(async (resolve, reject) => {
                const resultDiv = document.getElementById(`result-${index}`);
                const limitSelect = document.getElementById('scrape-limit');
                const limitVal = limitSelect ? parseInt(limitSelect.value) : 3;

                // UI Init
                resultDiv.innerHTML = `
                    <div style="font-size:0.85em; margin-bottom:4px; display:flex; justify-content:space-between;">
                        <span><span class="result-cell">@${instagramId}</span></span>
                        <span style="color:var(--accent-color); font-size:0.8em;" id="status-text-${index}">ğŸš€ ì‹œì‘...</span>
                    </div>
                    <div class="progress" style="height: 6px; background-color: #333;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                             style="width: 5%; background-color: var(--accent-color);"></div>
                    </div>
                `;

                try {
                    const response = await fetch('/api/auto_process_async', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            venue_name: venueName,
                            instagram_id: instagramId,
                            limit: limitVal
                        })
                    });
                    const initData = await response.json();

                    if (!initData.success) {
                        resultDiv.innerHTML += `<div style="color:red; font-size:0.8em;">${initData.error}</div>`;
                        resolve({ status: 'error', message: initData.error });
                        return;
                    }

                    const taskId = initData.task_id;
                    const startTime = Date.now();
                    let logCursor = 0;

                    const poll = setInterval(async () => {
                        try {
                            const statusResp = await fetch(`/api/task_status/${taskId}`);
                            if (!statusResp.ok) return;

                            const sData = await statusResp.json();
                            const pct = sData.progress || 0;
                            const logs = sData.logs || [];

                            // Update UI
                            const bar = resultDiv.querySelector('.progress-bar');
                            const statusTxt = document.getElementById(`status-text-${index}`);
                            if (bar) bar.style.width = `${Math.max(5, pct)}%`;
                            if (statusTxt) statusTxt.innerText = `${pct}%`;

                            // Log Terminal
                            const term = document.getElementById('log-terminal');
                            if (term && logs.length > logCursor) {
                                for (let i = logCursor; i < logs.length; i++) {
                                    term.innerHTML += `<div style="color: #ccc; font-size:0.85em;">[${venueName}] ${logs[i]}</div>`;
                                }
                                term.scrollTop = term.scrollHeight;
                                logCursor = logs.length;
                            }

                            // Completion Check
                            if (sData.status === 'completed') {
                                clearInterval(poll);
                                if (statusTxt) statusTxt.innerText = "Done";

                                const res = sData.result;
                                const details = res.details || [];

                                if (details.length > 0) window.reviewDataStore[venueName] = details;

                                renderFinalState(resultDiv, instagramId, venueName, index,
                                    res.saved_count || 0, res.scraped_count || 0, details.length > 0
                                );

                                resolve({
                                    status: 'success',
                                    savedCount: res.saved_count || 0,
                                    scrapedCount: res.scraped_count || 0,
                                    details: details
                                });

                            } else if (sData.status === 'error') {
                                clearInterval(poll);
                                resultDiv.innerHTML = `
                                    <span class="result-cell">@${instagramId}</span>
                                    <span style="color:red; font-size:0.9em;"> âŒ ${sData.message || 'Error'}</span>
                                `;
                                resolve({ status: 'error', message: sData.message });
                            }

                            // Timeout Safety (5 mins)
                            if (Date.now() - startTime > 300000) {
                                clearInterval(poll);
                                resultDiv.innerHTML += `<span style="color:red;">â° Timeout</span>`;
                                resolve({ status: 'error', message: 'Timeout' });
                            }

                        } catch (err) {
                            console.error("Poll Error", err);
                        }
                    }, 1500);

                } catch (e) {
                    console.error("Async launch error", e);
                    resultDiv.innerHTML = `<span style="color:red;">âš ï¸ ì‹œì‘ ì‹¤íŒ¨</span>`;
                    resolve({ status: 'error', message: e.toString() });
                }
            });
        }

        // Refactored AutoCollect with Promise-based Polling
        function autoCollect(venueName, instagramId, index) {
            return new Promise(async (resolve, reject) => {
                const resultDiv = document.getElementById(`result-${index}`);
                const limitSelect = document.getElementById('scrape-limit');
                const limitVal = limitSelect ? parseInt(limitSelect.value) : 3;

                // UI Init (Match batch_collection.html style)
                resultDiv.innerHTML = `
                    <div style="font-size:0.85em; margin-bottom:4px; display:flex; justify-content:space-between;">
                        <span><span class="result-cell">@${instagramId}</span></span>
                        <span style="color:var(--accent-color); font-size:0.8em;" id="status-text-${index}">ğŸš€ ì‹œì‘...</span>
                    </div>
                    <div class="progress" style="height: 6px; background-color: #333;">
                        <div id="progress-bar-${index}" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" 
                             style="width: 5%; background-color: var(--accent-color);"></div>
                    </div>
                `;

                try {
                    const response = await fetch('/api/auto_process_async', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            venue_name: venueName,
                            instagram_id: instagramId,
                            limit: limitVal
                        })
                    });
                    const initData = await response.json();

                    if (!initData.success) {
                        resultDiv.innerHTML += `<div style="color:red; font-size:0.8em;">${initData.error}</div>`;
                        resolve({ status: 'error', message: initData.error });
                        return;
                    }

                    const taskId = initData.task_id;
                    const startTime = Date.now();
                    let logCursor = 0;

                    const poll = setInterval(async () => {
                        try {
                            const statusResp = await fetch(`/api/task_status/${taskId}`);
                            if (!statusResp.ok) return;

                            const sData = await statusResp.json();
                            const pct = sData.progress || 0;
                            const logs = sData.logs || [];

                            // Update UI
                            const bar = document.getElementById(`progress-bar-${index}`);
                            const statusTxt = document.getElementById(`status-text-${index}`);

                            if (bar) bar.style.width = `${Math.max(5, pct)}%`;

                            // Log Terminal & Short Status
                            const term = document.getElementById('log-terminal');
                            let shortStatus = "ì²˜ë¦¬ì¤‘";

                            if (logs.length > 0) {
                                const lastLog = logs[logs.length - 1];
                                if (lastLog.includes("Scraping")) shortStatus = "ìˆ˜ì§‘";
                                else if (lastLog.includes("OCR")) shortStatus = "OCR";
                                else if (lastLog.includes("AI")) shortStatus = "AI";
                                else if (lastLog.includes("Saving")) shortStatus = "ì €ì¥";

                                if (term && logs.length > logCursor) {
                                    for (let i = logCursor; i < logs.length; i++) {
                                        term.innerHTML += `<div style="color: #ccc; font-size:0.85em;">[${venueName}] ${logs[i]}</div>`;
                                    }
                                    term.scrollTop = term.scrollHeight;
                                    logCursor = logs.length;
                                }
                            }

                            // Real-time Timer
                            const elapsed = ((Date.now() - startTime) / 1000).toFixed(0);
                            if (statusTxt) statusTxt.innerText = `${shortStatus} ${pct}% (${elapsed}s)`;

                            // Completion Check
                            if (sData.status === 'completed') {
                                clearInterval(poll);
                                if (statusTxt) {
                                    statusTxt.innerText = "ì™„ë£Œ";
                                    statusTxt.style.color = "#28a745";
                                }
                                if (bar) {
                                    bar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                                    bar.classList.add('bg-success');
                                    bar.style.width = '100%';
                                }

                                const res = sData.result;
                                const details = res.details || [];

                                if (details.length > 0) window.reviewDataStore[venueName] = details;

                                renderFinalState(resultDiv, instagramId, venueName, index,
                                    res.saved_count || 0, res.scraped_count || 0, details.length > 0
                                );

                                resolve({
                                    status: 'success',
                                    savedCount: res.saved_count || 0,
                                    scrapedCount: res.scraped_count || 0,
                                    details: details
                                });

                            } else if (sData.status === 'error') {
                                clearInterval(poll);
                                resultDiv.innerHTML = `
                                    <span class="result-cell">@${instagramId}</span>
                                    <span style="color:red; font-size:0.9em;"> âŒ ${sData.message || 'Error'}</span>
                                `;
                                resolve({ status: 'error', message: sData.message });
                            }

                            // Timeout Safety (5 mins)
                            if (Date.now() - startTime > 300000) {
                                clearInterval(poll);
                                resultDiv.innerHTML += `<span style="color:red;">â° Timeout</span>`;
                                resolve({ status: 'error', message: 'Timeout' });
                            }

                        } catch (err) {
                            console.error("Poll Error", err);
                        }
                    }, 1500);

                } catch (e) {
                    console.error("Async launch error", e);
                    resultDiv.innerHTML = `<span style="color:red;">âš ï¸ ì‹œì‘ ì‹¤íŒ¨</span>`;
                    resolve({ status: 'error', message: e.toString() });
                }
            });
        }

        function renderFinalState(container, instagramId, venueName, index, savedCount, scrapedCount, hasDetails) {
            container.innerHTML = ""; // Clear progress bar

            // Header
            container.innerHTML += `<span class="result-cell">@${instagramId}</span>`;
            container.innerHTML += `<a href="https://instagram.com/${instagramId}" target="_blank" style="font-size:0.8em; margin-left:5px; text-decoration:none;">ğŸ”—</a>`;

            if (savedCount > 0) {
                container.innerHTML += `<span style="color:#28a745; font-weight:bold; font-size:0.9em; margin-left:5px;"> âœ… ${savedCount}ê±´ ì €ì¥</span>`;
            } else if (scrapedCount > 0) {
                container.innerHTML += `<span style="color:#ffc107; font-weight:bold; font-size:0.9em; margin-left:5px;"> âš ï¸ ì €ì¥ 0ê±´</span>`;
            } else {
                container.innerHTML += `<span style="color:#aaa; font-size:0.9em; margin-left:5px;"> â„¹ï¸ ê²Œì‹œë¬¼ ì—†ìŒ</span>`;
            }

            // Review Button
            if (hasDetails) {
                container.innerHTML += `
                     <button class="btn btn-sm btn-outline-light" style="font-size: 0.7em; margin-left:5px; border:1px solid #555;" 
                        onclick="showReviewModal(${index}, '${venueName}')">
                        ğŸ”ê²€í† 
                    </button>
                 `;
            }
        }

        function manualInput(venueName, index) {
            const resultDiv = document.getElementById(`result-${index}`);
            const inputId = `manual-input-${index}`;

            resultDiv.innerHTML = `
                <input type="text" id="${inputId}" placeholder="@id or id" style="width: 100px; padding: 2px; font-size: 0.8em;">
                <button class="btn btn-success" style="padding: 2px 8px; font-size: 0.8em;" onclick="saveManualInput('${venueName}', ${index})">ì €ì¥</button>
                <button class="btn btn-secondary" style="padding: 2px 5px; font-size: 0.8em;" onclick="restoreSearch('${venueName}', ${index})">ì·¨ì†Œ</button>
            `;
            document.getElementById(inputId).focus();
        }

        async function saveManualInput(venueName, index) {
            const input = document.getElementById(`manual-input-${index}`);
            let value = input.value.trim();
            if (!value) {
                alert("IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                return;
            }
            if (value.startsWith('@')) value = value.substring(1);

            const resultDiv = document.getElementById(`result-${index}`);
            resultDiv.innerHTML = '<span style="color:var(--accent-color);">ğŸ’¾ ì €ì¥ ì¤‘...</span>';

            try {
                const response = await fetch('/api/save_manual_id', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ venue_name: venueName, instagram_id: value })
                });
                const data = await response.json();

                if (data.success) {
                    // Auto Trigger Collection for Manual too!
                    await autoCollect(venueName, value, index);
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + data.error);
                    restoreSearch(venueName, index);
                }
            } catch (e) {
                alert("ì˜¤ë¥˜: " + e);
                restoreSearch(venueName, index);
            }
        }

        function restoreSearch(venueName, index) {
            const resultDiv = document.getElementById(`result-${index}`);
            resultDiv.innerHTML = `
                <button id="btn-${index}" class="btn btn-primary search-btn"
                    onclick="searchVenue('${venueName}', ${index})">
                    ğŸ” ê²€ìƒ‰
                </button>
            `;
        }

        async function processAllOnPage() {
            if (isSearching) return;

            // Collect all pending buttons
            const buttons = Array.from(document.querySelectorAll('.search-btn'));
            if (buttons.length === 0) {
                alert("ì´ í˜ì´ì§€ì— ê²€ìƒ‰í•  í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤ (ë¶„ì„ ì™„ë£Œë¨).");
                return;
            }

            const concurrency = parseInt(document.getElementById('concurrency-level').value) || 1;
            const limit = parseInt(document.getElementById('scrape-limit').value) || 1;

            if (!confirm(`ì´ ${buttons.length}ê°œì˜ ê³µì—°ì¥ì„ ë³‘ë ¬ ì²˜ë¦¬í•©ë‹ˆë‹¤. (ë™ì‹œì‘ì—…: ${concurrency}ê°œ)\n(ê²Œì‹œë¬¼ ${limit}ê°œì”© ìˆ˜ì§‘)\n\nì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                return;
            }

            isSearching = true;
            stopRequested = false;

            // UI Setup
            document.getElementById('btn-start-all').style.display = 'none';
            const stopBtn = document.getElementById('btn-stop-all');
            stopBtn.style.display = 'inline-flex';
            stopBtn.innerText = "â¹ï¸ ì¤‘ì§€";
            stopBtn.disabled = false;

            const dashboard = document.getElementById('progress-dashboard');
            dashboard.style.display = 'block';

            // Log Header
            const term = document.getElementById('log-terminal');
            const timeStr = new Date().toLocaleTimeString();
            term.innerHTML += `<div style="color: #ffff00; margin-top: 10px; border-top: 1px dashed #555; padding-top: 5px;">=== ë°°ì¹˜ ê²€ìƒ‰ ì‹œì‘ (ë™ì‹œ: ${concurrency}) ===</div>`;
            term.scrollTop = term.scrollHeight;

            // Global Init
            globalTotalTasks = buttons.length;
            globalCompletedTasks = 0;
            updateGlobalProgress(0);

            // Local Results Array 
            const allBatchResults = [];
            const startTime = Date.now();

            // Concurrent Worker Pool
            let currentIndex = 0;
            const pool = [];

            async function worker() {
                while (currentIndex < buttons.length && !stopRequested) {
                    const btn = buttons[currentIndex++];
                    if (!document.body.contains(btn)) continue;

                    // Extract params robustly from DOM
                    let name = '';
                    let idx = '';

                    try {
                        const row = btn.closest('tr');
                        if (row && row.cells.length > 0) {
                            name = row.cells[0].innerText.trim(); // Get Name from Cell 0
                        }

                        // Get Index from Button ID logic or attribute
                        if (btn.id && btn.id.startsWith('btn-')) {
                            idx = btn.id.split('-')[1];
                        } else {
                            const onclickText = btn.getAttribute('onclick');
                            const match = onclickText ? onclickText.match(/,\s*(\d+)\)/) : null;
                            if (match) idx = match[1];
                        }

                        if (!name) {
                            // Last resort: regex
                            const onclickText = btn.getAttribute('onclick');
                            const match = onclickText ? onclickText.match(/searchVenue\(['"](.+?)['"]/) : null;
                            if (match) name = match[1];
                        }
                    } catch (e) {
                        console.error("Param extraction failed", e);
                    }

                    if (name && idx) {
                        // Log
                        term.innerHTML += `<div style="color: #fff;">â–¶ ${name} ê²€ìƒ‰ ì‹œì‘</div>`;
                        term.scrollTop = term.scrollHeight;

                        // UI Update
                        const resultDiv = document.getElementById(`result-${idx}`);
                        if (resultDiv) resultDiv.innerHTML = '<span style="color:var(--accent-color);">â³ ëŒ€ê¸°...</span>';

                        // Execute
                        try {
                            const result = await searchVenue(name, idx);
                            // Result handling
                            if (result) {
                                allBatchResults.push(result);
                            } else {
                                const err = { status: 'error', message: 'No result returned' };
                                allBatchResults.push(err);
                                term.innerHTML += `<div style="color: red; font-size:0.8em;">[Error] No result for ${name}</div>`;
                            }
                        } catch (e) {
                            console.error(e);
                            const err = { status: 'error', message: e.toString() };
                            allBatchResults.push(err);
                            term.innerHTML += `<div style="color: red; font-size:0.8em;">[Exception] ${name}: ${e}</div>`;
                        }

                        globalCompletedTasks++;
                        updateGlobalProgress(0);
                    } else {
                        // Debug mismatch
                        term.innerHTML += `<div style="color: orange; font-size:0.8em;">âš ï¸ Skip: Can't extract name/index for button.</div>`;
                    }
                }
            }

            // Spawn workers
            for (let w = 0; w < concurrency; w++) {
                pool.push(worker());
            }

            // Wait for all workers
            await Promise.all(pool);

            // Done
            isSearching = false;
            document.getElementById('btn-start-all').style.display = 'inline-block';
            stopBtn.style.display = 'none';

            term.innerHTML += `<div style="color: #0f0; margin-top: 10px;">=== ëª¨ë“  ì‘ì—… ì™„ë£Œ (ì§‘ê³„ëœ ê²°ê³¼: ${allBatchResults.length}ê±´) ===</div>`;
            term.scrollTop = term.scrollHeight;

            if (!stopRequested) {
                // Show Summary Report
                const totalDuration = (Date.now() - startTime) / 1000;
                if (allBatchResults.length === 0) {
                    alert("âš ï¸ ì£¼ì˜: ìˆ˜ì§‘ëœ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                } else {
                    showBatchSummaryReport(totalDuration, allBatchResults);
                }
            } else {
                alert("ì‘ì—…ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function resetAllData() {
            if (!confirm("âš ï¸ ê²½ê³ : ì €ì¥ëœ ëª¨ë“  ì¸ìŠ¤íƒ€ê·¸ë¨ ID ì°¾ê¸° ê²°ê³¼ê°€ ì‚­ì œë©ë‹ˆë‹¤.\n\nì •ë§ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }

            try {
                const response = await fetch('/api/reset_discovery', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ scope: 'all' })
                });
                const data = await response.json();

                if (data.success) {
                    alert("ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.");
                    window.location.reload();
                } else {
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + (data.error || 'Unknown error'));
                }
            } catch (e) {
                alert("í†µì‹  ì˜¤ë¥˜: " + e);
            }
        }

        async function resetExcelFile() {
            if (!confirm("âš ï¸ ì—‘ì…€/ê³µì—°ì¥ ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí•˜ê³  ì´ˆê¸° í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                return;
            }
            try {
                const response = await fetch('/api/reset_excel', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    alert("íŒŒì¼ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. ì—…ë¡œë“œ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                    window.location.reload();
                } else {
                    alert("ì˜¤ë¥˜: " + (data.error || 'Unknown'));
                }
            } catch (e) {
                alert("í†µì‹  ì˜¤ë¥˜: " + e);
            }
        }

        // BFCache Fix: Reload page when returning from history if needed
        window.addEventListener('pageshow', function (event) {
            if (event.persisted) {
                console.log('Page restored from BFCache. Reloading...');
                window.location.reload();
            }
        });

        // Global store for Review Data
        window.reviewDataStore = {};

        function showReviewModal(index, itemKey) {
            const data = window.reviewDataStore[itemKey];
            if (!data) return;

            const modalBody = document.getElementById('review-modal-body');
            modalBody.innerHTML = '';

            data.forEach((item, idx) => {
                // Determine status badge
                let statusBadge = '';
                if (item.db_status === 'Saved') {
                    statusBadge = '<span class="badge bg-success">âœ… ì €ì¥ë¨</span>';
                } else if (item.db_status === 'Duplicate') {
                    statusBadge = '<span class="badge bg-warning text-dark">âš ï¸ ì¤‘ë³µ</span>';
                } else {
                    statusBadge = '<span class="badge bg-info text-dark">ğŸ” ê²€í†  ëŒ€ê¸°</span>';
                }

                const card = document.createElement('div');
                card.className = "card mb-3 bg-secondary";
                card.style.borderColor = "#555";

                // Truncate caption for display
                const shortCaption = item.caption ? (item.caption.substring(0, 100) + (item.caption.length > 100 ? "..." : "")) : "(ë‚´ìš© ì—†ìŒ)";

                const datesHTML = (item.dates_found && item.dates_found.length > 0)
                    ? item.dates_found.map(d => `<span class="badge bg-primary me-1">${d}</span>`).join(" ")
                    : '<span class="text-muted small">(ê°ì§€ëœ ë‚ ì§œ ì—†ìŒ)</span>';

                const imgSrc = item.image_path
                    ? `/load_image?path=${encodeURIComponent(item.image_path)}`
                    : '/static/placeholder_image.png';

                card.innerHTML = `
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                             <h6 class="card-title text-white mb-0">ê²Œì‹œë¬¼ #${idx + 1} (${item.shortcode})</h6>
                             ${statusBadge}
                        </div>
                        <div class="row g-2">
                             <div class="col-md-4">
                                <a href="https://instagram.com/p/${item.shortcode}" target="_blank">
                                    <img src="${imgSrc}" style="width:100%; height:150px; object-fit:cover; background:#333;" alt="Post Image">
                                </a>
                                <div class="small mt-1 text-light">íŒŒì¼ëª…: ${item.filename || '-'}</div>
                             </div>
                             <div class="col-md-8">
                                <div class="mb-2">
                                    <strong class="text-info">ğŸ“… ê°ì§€ëœ ë‚ ì§œ:</strong> ${datesHTML}
                                </div>
                                <div class="mb-2">
                                    <strong class="text-warning">ğŸ¤ ì¶”ë¡  ì•„í‹°ìŠ¤íŠ¸:</strong> <span class="text-white">${item.inferred_artist || '-'}</span>
                                    <br>
                                    <strong class="text-warning">ğŸ›ï¸ ì¶”ë¡  ì¥ì†Œ:</strong> <span class="text-white">${item.inferred_venue || '-'}</span>
                                </div>
                                
                                <h6 class="text-light mt-3" style="font-size:0.9em;">ğŸ“ ë³¸ë¬¸ ìš”ì•½:</h6>
                                <p class="text-light small border p-2 rounded" style="background:#222; max-height:80px; overflow-y:auto;">${shortCaption}</p>
                             </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button class="btn btn-primary btn-sm" onclick='saveReviewItem("${itemKey}", ${idx}, this)' ${item.db_status === 'Saved' ? 'disabled' : ''}>
                                ${item.db_status === 'Saved' ? 'âœ… ì €ì¥ ì™„ë£Œ' : 'ğŸ’¾ DB ì €ì¥'}
                            </button>
                        </div>
                    </div>
                `;
                modalBody.appendChild(card);
            });

            const modal = new bootstrap.Modal(document.getElementById('reviewModal'));
            modal.show();
        }

        async function saveReviewItem(itemKey, itemIndex, btnElement) {
            const item = window.reviewDataStore[itemKey][itemIndex];
            // Construct payload similar to batch_collection logic
            const payload = {
                venue_id: 'NEW',
                new_venue: item.inferred_venue,
                artist_id: 'NEW',
                new_artist: item.inferred_artist,
                event_name: item.event_name || `${item.inferred_artist} Live`,
                event_date: (item.dates_found && item.dates_found.length > 0) ? item.dates_found[0] : null,
                content: (item.caption || "") + "\n[Reviewed Manual Save]",
                filename: item.filename,
                image_path: item.image_path
            };

            if (!payload.event_date) {
                if (!confirm("âš ï¸ ë‚ ì§œê°€ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì¶”í›„ ëŒ€ì‹œë³´ë“œì—ì„œ ìˆ˜ì • í•„ìš”)")) return;
            }

            btnElement.disabled = true;
            btnElement.innerText = "ì €ì¥ ì¤‘...";

            try {
                let successCount = 0;
                // If multiple dates, save each
                const datesToSave = (item.dates_found && item.dates_found.length > 0) ? item.dates_found : [null];

                for (const d of datesToSave) {
                    if (!d && datesToSave.length > 1) continue; // Skip null if checking multiples
                    const singlePayload = { ...payload, event_date: d };

                    const resp = await fetch('/api/save_event_manual', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(singlePayload)
                    });
                    const res = await resp.json();
                    if (res.success) successCount++;
                }

                if (successCount > 0) {
                    btnElement.className = "btn btn-success btn-sm";
                    btnElement.innerText = "âœ… ì €ì¥ ì™„ë£Œ";
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨");
                    btnElement.innerText = "ì‹¤íŒ¨";
                    btnElement.disabled = false;
                }
            } catch (e) {
                console.error(e);
                alert("í†µì‹  ì˜¤ë¥˜: " + e);
                btnElement.disabled = false;
            }
        }
    </script>

    <!-- Include Bootstrap JS (Required for Modal) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Review Modal Structure -->
    <div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white" style="border: 1px solid #444;">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="reviewModalLabel">ğŸ—ï¸ ìˆ˜ì§‘ ë°ì´í„° ê²€í†  & ì €ì¥</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body" id="review-modal-body">
                    <!-- Content injected by JS -->
                    <p class="text-center text-muted">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ë‹«ê¸°</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Summary Modal -->
    <div class="modal fade" id="batchSummaryModal" tabindex="-1" aria-labelledby="batchSummaryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content bg-dark text-white border-light">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title" id="batchSummaryModalLabel">ğŸ‰ ë°°ì¹˜ ì‘ì—… ê²°ê³¼ ë¦¬í¬íŠ¸ (Batch Report)</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h2 class="display-6 fw-bold text-success">ì‘ì—… ì™„ë£Œ!</h2>
                        <p class="lead text-light">
                            ì´ ì†Œìš” ì‹œê°„: <span id="summary-total-time" class="fw-bold text-warning">00:00</span>
                        </p>
                    </div>

                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="card bg-secondary text-white border-0 shadow-sm">
                                <div class="card-body">
                                    <h3 class="fw-bold" id="summary-total-count">0</h3>
                                    <small class="text-light">ì´ ì‘ì—… ê³„ì •</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white border-0 shadow-sm">
                                <div class="card-body">
                                    <h3 class="fw-bold" id="summary-success-count">0</h3>
                                    <small class="text-white">ì„±ê³µ (Success)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white border-0 shadow-sm">
                                <div class="card-body">
                                    <h3 class="fw-bold" id="summary-fail-count">0</h3>
                                    <small class="text-white">ì‹¤íŒ¨ (Fail)</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-info text-dark border-0 shadow-sm">
                                <div class="card-body">
                                    <h3 class="fw-bold" id="summary-saved-count">0</h3>
                                    <small class="text-dark">ì €ì¥ëœ ê³µì—°</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-dark border-secondary d-flex justify-content-between align-items-center">
                        <div>
                            <strong>ğŸ“Š ë°ì´í„° ìˆ˜ì§‘ ì„±ê³¼:</strong>
                            ì´ <span id="summary-scraped-total" class="text-primary fw-bold"
                                style="font-size: 1.2em;">0</span>ê°œì˜ ê²Œì‹œë¬¼ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤.
                        </div>
                        <div class="text-end">
                            <small class="text-muted">í‰ê·  ì²˜ë¦¬ ì†ë„</small><br>
                            <span id="summary-avg-time" class="fw-bold text-dark" style="font-size: 1.2em;">0.0s</span>
                            / ê³„ì •
                        </div>
                    </div>

                </div>
                <div class="modal-footer border-secondary">
                    <button type="button" class="btn btn-primary w-100" data-bs-dismiss="modal">í™•ì¸ (Close)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showBatchSummaryReport(totalSeconds, results) {
            // Calculate Stats
            const totalCount = results.length;
            const successCount = results.filter(r => r.status === 'success').length;
            const failCount = results.filter(r => r.status === 'error').length;

            const totalSaved = results.reduce((acc, r) => acc + (r.savedCount || 0), 0);
            const totalScraped = results.reduce((acc, r) => acc + (r.scrapedCount || 0), 0);

            const avgTime = totalCount > 0 ? (totalSeconds / totalCount).toFixed(1) : 0;

            // Format Duration
            const mins = Math.floor(totalSeconds / 60);
            const secs = Math.floor(totalSeconds % 60);
            const timeStr = mins > 0 ? `${mins}ë¶„ ${secs}ì´ˆ` : `${secs}ì´ˆ`;

            // Update DOM
            document.getElementById('summary-total-time').innerText = timeStr;
            document.getElementById('summary-total-count').innerText = totalCount;
            document.getElementById('summary-success-count').innerText = successCount;
            document.getElementById('summary-fail-count').innerText = failCount;
            document.getElementById('summary-saved-count').innerText = totalSaved;
            document.getElementById('summary-scraped-total').innerText = totalScraped;
            document.getElementById('summary-avg-time').innerText = `${avgTime}s`;

            // Show Modal
            const modal = new bootstrap.Modal(document.getElementById('batchSummaryModal'));
            modal.show();
        }
    </script>

    {% include 'components/developer_log.html' %}
</body>