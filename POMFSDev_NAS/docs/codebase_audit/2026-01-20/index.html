<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Codebase Audit Report - P.O.MFS</title>
    <link rel="stylesheet" href="../style.css">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --accent: #e94560;
            --accent-secondary: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #a0a0a0;
            --success: #00d26a;
            --warning: #ffc107;
            --danger: #e94560;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
            padding: 40px 20px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        header .meta {
            color: rgba(255,255,255,0.8);
            font-size: 0.95rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .nav-tab {
            padding: 12px 24px;
            background: var(--bg-card);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        .nav-tab:hover, .nav-tab.active {
            background: var(--accent);
        }
        
        .section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .section h2 {
            color: var(--accent);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--accent-secondary);
        }
        
        .section h3 {
            color: var(--text-primary);
            margin: 20px 0 10px;
        }
        
        .priority-critical { color: #ff4757; }
        .priority-high { color: #ffa502; }
        .priority-medium { color: #ffc107; }
        .priority-low { color: #2ed573; }
        
        .issue-card {
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            border-left: 4px solid var(--accent);
        }
        
        .issue-card.critical { border-left-color: #ff4757; }
        .issue-card.high { border-left-color: #ffa502; }
        .issue-card.medium { border-left-color: #ffc107; }
        .issue-card.low { border-left-color: #2ed573; }
        
        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .issue-title {
            font-size: 1.1rem;
            font-weight: 600;
        }
        
        .priority-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .priority-badge.critical { background: #ff4757; }
        .priority-badge.high { background: #ffa502; color: #000; }
        .priority-badge.medium { background: #ffc107; color: #000; }
        .priority-badge.low { background: #2ed573; color: #000; }
        
        pre {
            background: #0d1117;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9rem;
            margin: 10px 0;
        }
        
        code {
            color: #79c0ff;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--accent-secondary);
        }
        
        th {
            background: rgba(233, 69, 96, 0.2);
            color: var(--accent);
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(0,0,0,0.3);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--accent);
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        .roadmap-phase {
            margin: 20px 0;
        }
        
        .phase-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .phase-number {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
        }
        
        .back-link {
            display: inline-block;
            color: var(--text-secondary);
            text-decoration: none;
            margin-bottom: 20px;
            transition: color 0.3s;
        }
        
        .back-link:hover {
            color: var(--accent);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }
            
            .nav-tabs {
                flex-direction: column;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">&larr; 대시보드로 돌아가기</a>
        
        <header>
            <h1>Codebase Audit Report</h1>
            <p class="meta">P.O.MFS v1.9.6 | 감사일: 2026-01-20</p>
        </header>
        
        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('overview')">개요</button>
            <button class="nav-tab" onclick="showTab('performance')">성능 분석</button>
            <button class="nav-tab" onclick="showTab('security')">보안</button>
            <button class="nav-tab" onclick="showTab('architecture')">아키텍처</button>
            <button class="nav-tab" onclick="showTab('roadmap')">개선 로드맵</button>
        </div>
        
        <div id="overview" class="tab-content active">
            <div class="section">
                <h2>시스템 현황</h2>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value">4,780</div>
                        <div class="stat-label">총 코드 라인</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">17</div>
                        <div class="stat-label">Python 파일</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">1.5GB</div>
                        <div class="stat-label">scraped_data 용량</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">12</div>
                        <div class="stat-label">템플릿 파일</div>
                    </div>
                </div>
            </div>
            
            <div class="section">
                <h2>파일 구조</h2>
                <table>
                    <thead>
                        <tr>
                            <th>파일명</th>
                            <th>라인 수</th>
                            <th>역할</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td>app.py</td><td>2,081</td><td>Flask 메인 앱</td></tr>
                        <tr><td>db_helpers.py</td><td>443</td><td>MusicFeed DB 헬퍼</td></tr>
                        <tr><td>automation.py</td><td>418</td><td>자동 처리 파이프라인</td></tr>
                        <tr><td>analyzer.py</td><td>296</td><td>Mistral OCR/LLM</td></tr>
                        <tr><td>db_utils.py</td><td>234</td><td>Neon DB 유틸리티</td></tr>
                        <tr><td>geocoder.py</td><td>201</td><td>Geocoding API</td></tr>
                        <tr><td>기타 11개</td><td>1,107</td><td>스크래핑, 업로드 등</td></tr>
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <h2>발견된 문제 요약</h2>
                <div class="stats-grid">
                    <div class="stat-card" style="border-left: 4px solid #ff4757;">
                        <div class="stat-value" style="color: #ff4757;">2</div>
                        <div class="stat-label">Critical</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #ffa502;">
                        <div class="stat-value" style="color: #ffa502;">3</div>
                        <div class="stat-label">High</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #ffc107;">
                        <div class="stat-value" style="color: #ffc107;">5</div>
                        <div class="stat-label">Medium</div>
                    </div>
                    <div class="stat-card" style="border-left: 4px solid #2ed573;">
                        <div class="stat-value" style="color: #2ed573;">2</div>
                        <div class="stat-label">Low</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="performance" class="tab-content">
            <div class="section">
                <h2>성능 분석</h2>
                
                <div class="issue-card critical">
                    <div class="issue-header">
                        <span class="issue-title">find_local_image() 성능 병목</span>
                        <span class="priority-badge critical">Critical</span>
                    </div>
                    <p><strong>위치:</strong> app.py (review 함수)</p>
                    <p><strong>문제:</strong> 매 포스트마다 glob 패턴으로 전체 디렉토리 스캔 (O(n*m) 복잡도)</p>
                    <pre><code>def find_local_image(username, shortcode):
    pattern = f"scraped_data/*/{username}/{shortcode}*.jpg"
    matches = glob.glob(pattern)  # 매번 1.5GB 스캔</code></pre>
                    <p><strong>권장 해결책:</strong> 캐시 레이어 추가 - 서버 시작 시 shortcode→path 맵 구축</p>
                    <p><strong>예상 개선:</strong> 응답 시간 90% 단축</p>
                </div>
                
                <div class="issue-card high">
                    <div class="issue-header">
                        <span class="issue-title">app.py 거대 파일 (2,081 라인)</span>
                        <span class="priority-badge high">High</span>
                    </div>
                    <p><strong>문제:</strong> 단일 파일에 모든 라우트, DB 로직, 유틸리티 혼재</p>
                    <p><strong>권장 해결책:</strong> 라우트별 모듈 분리 (routes/, services/, utils/)</p>
                    <p><strong>예상 개선:</strong> 유지보수성 50% 향상</p>
                </div>
                
                <div class="issue-card high">
                    <div class="issue-header">
                        <span class="issue-title">동기식 I/O 블로킹</span>
                        <span class="priority-badge high">High</span>
                    </div>
                    <p><strong>위치:</strong> automation.py, analyzer.py, geocoder.py</p>
                    <p><strong>문제:</strong> Mistral API, GCS 업로드, Geocoding API 모두 동기식 호출</p>
                    <p><strong>권장 해결책:</strong> asyncio + ThreadPoolExecutor 도입</p>
                    <p><strong>예상 개선:</strong> 처리량 3-5배 향상</p>
                </div>
                
                <div class="issue-card medium">
                    <div class="issue-header">
                        <span class="issue-title">N+1 쿼리 문제</span>
                        <span class="priority-badge medium">Medium</span>
                    </div>
                    <p><strong>문제:</strong> 리스트 조회 후 각 항목별 추가 쿼리 발생</p>
                    <p><strong>권장 해결책:</strong> JOIN을 사용한 단일 쿼리로 변경</p>
                    <p><strong>예상 개선:</strong> DB 쿼리 수 80% 감소</p>
                </div>
                
                <div class="issue-card medium">
                    <div class="issue-header">
                        <span class="issue-title">scraped_data 무제한 성장</span>
                        <span class="priority-badge medium">Medium</span>
                    </div>
                    <p><strong>현재:</strong> 1.5GB, 정리 전략 없음</p>
                    <p><strong>권장 해결책:</strong> 30일 이상 된 데이터 자동 정리 크론잡</p>
                    <p><strong>예상 개선:</strong> 디스크 사용량 70% 감소</p>
                </div>
            </div>
        </div>
        
        <div id="security" class="tab-content">
            <div class="section">
                <h2>보안 분석</h2>
                
                <div class="issue-card critical">
                    <div class="issue-header">
                        <span class="issue-title">하드코딩된 API 키</span>
                        <span class="priority-badge critical">Critical</span>
                    </div>
                    <p><strong>위치:</strong> automation.py, utils.py</p>
                    <p><strong>문제:</strong> MISTRAL_API_KEY 폴백 값, SMTP 자격증명이 소스 코드에 노출</p>
                    <pre><code># 위험한 코드
MISTRAL_API_KEY = os.getenv("MISTRAL_API_KEY", "sk-xxxx...")  # 폴백 값 노출!</code></pre>
                    <p><strong>권장 해결책:</strong> 환경 변수만 사용, 폴백 값 제거</p>
                    <pre><code># 안전한 코드
MISTRAL_API_KEY = os.environ["MISTRAL_API_KEY"]  # 없으면 KeyError</code></pre>
                    <p style="color: #ff4757;"><strong>즉시 조치 필요</strong></p>
                </div>
                
                <div class="issue-card low">
                    <div class="issue-header">
                        <span class="issue-title">경로 순회 취약점</span>
                        <span class="priority-badge low">Low (Safe)</span>
                    </div>
                    <p><strong>분석 결과:</strong> Flask의 send_from_directory 사용으로 안전하게 처리됨</p>
                    <p style="color: #2ed573;">문제 없음</p>
                </div>
                
                <div class="issue-card low">
                    <div class="issue-header">
                        <span class="issue-title">SQL 인젝션</span>
                        <span class="priority-badge low">Low (Safe)</span>
                    </div>
                    <p><strong>분석 결과:</strong> psycopg2 파라미터화된 쿼리 사용으로 안전</p>
                    <p style="color: #2ed573;">문제 없음</p>
                </div>
            </div>
        </div>
        
        <div id="architecture" class="tab-content">
            <div class="section">
                <h2>현재 아키텍처</h2>
                <pre style="text-align: center; font-size: 0.85rem;">
┌─────────────────────────────────────────────────────┐
│                    app.py (2,081 lines)             │
│  ┌─────────────────────────────────────────────┐    │
│  │  Routes + Business Logic + DB Access        │    │
│  │  (All mixed together)                       │    │
│  └─────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────┘
         │
         ├── automation.py (파이프라인)
         ├── analyzer.py (AI 분석)
         ├── db_helpers.py (MusicFeed DB)
         ├── db_utils.py (Neon DB)
         └── gcs_uploader.py (이미지 업로드)
                </pre>
            </div>
            
            <div class="section">
                <h2>권장 아키텍처</h2>
                <pre style="text-align: center; font-size: 0.85rem;">
┌─────────────────────────────────────────────────────┐
│                  Presentation Layer                 │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐       │
│  │ Routes    │  │ Templates │  │ Static    │       │
│  └───────────┘  └───────────┘  └───────────┘       │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│                   Service Layer                     │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐       │
│  │ EventSvc  │  │ ImageSvc  │  │ ScrapeSvc │       │
│  └───────────┘  └───────────┘  └───────────┘       │
└─────────────────────────────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────────────────────┐
│                   Data Layer                        │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐       │
│  │ NeonRepo  │  │ MFPRepo   │  │ GCSClient │       │
│  └───────────┘  └───────────┘  └───────────┘       │
└─────────────────────────────────────────────────────┘
                </pre>
                <h3>권장 폴더 구조</h3>
                <pre><code>app/
├── __init__.py          # Flask 앱 팩토리
├── routes/
│   ├── batch.py         # 배치 수집 관련 라우트
│   ├── review.py        # 리뷰 페이지 라우트
│   ├── registered.py    # 등록 이벤트 라우트
│   ├── api.py           # API 엔드포인트
│   └── test_tool.py     # 테스트 도구 라우트
├── services/
│   ├── event_service.py
│   └── image_service.py
└── utils/
    └── helpers.py</code></pre>
            </div>
        </div>
        
        <div id="roadmap" class="tab-content">
            <div class="section">
                <h2>개선 로드맵</h2>
                
                <div class="roadmap-phase">
                    <div class="phase-header">
                        <div class="phase-number">1</div>
                        <div>
                            <h3>Phase 1: 즉시 조치 (1주일 내)</h3>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>우선순위</th>
                                <th>작업</th>
                                <th>예상 시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="priority-badge critical">Critical</span></td>
                                <td>하드코딩된 시크릿 제거</td>
                                <td>2시간</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge critical">Critical</span></td>
                                <td>find_local_image 캐시 구현</td>
                                <td>4시간</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge high">High</span></td>
                                <td>에러 핸들링 개선</td>
                                <td>8시간</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="roadmap-phase">
                    <div class="phase-header">
                        <div class="phase-number">2</div>
                        <div>
                            <h3>Phase 2: 단기 개선 (1개월 내)</h3>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>우선순위</th>
                                <th>작업</th>
                                <th>예상 시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="priority-badge high">High</span></td>
                                <td>app.py 분리 (라우트/서비스)</td>
                                <td>16시간</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge high">High</span></td>
                                <td>비동기 처리 도입</td>
                                <td>12시간</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge medium">Medium</span></td>
                                <td>N+1 쿼리 최적화</td>
                                <td>8시간</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="roadmap-phase">
                    <div class="phase-header">
                        <div class="phase-number">3</div>
                        <div>
                            <h3>Phase 3: 장기 개선 (3개월 내)</h3>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>우선순위</th>
                                <th>작업</th>
                                <th>예상 시간</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><span class="priority-badge medium">Medium</span></td>
                                <td>타입 힌트 추가</td>
                                <td>16시간</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge medium">Medium</span></td>
                                <td>scraped_data 정리 자동화</td>
                                <td>4시간</td>
                            </tr>
                            <tr>
                                <td><span class="priority-badge medium">Medium</span></td>
                                <td>테스트 코드 작성</td>
                                <td>24시간</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="section">
                <h2>성능 지표 목표</h2>
                <table>
                    <thead>
                        <tr>
                            <th>지표</th>
                            <th>현재</th>
                            <th>목표</th>
                            <th>개선율</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Review 페이지 로딩</td>
                            <td>~5초</td>
                            <td>&lt;1초</td>
                            <td style="color: #2ed573;">80%</td>
                        </tr>
                        <tr>
                            <td>배치 처리 속도</td>
                            <td>10건/분</td>
                            <td>30건/분</td>
                            <td style="color: #2ed573;">200%</td>
                        </tr>
                        <tr>
                            <td>메모리 사용량</td>
                            <td>500MB</td>
                            <td>300MB</td>
                            <td style="color: #2ed573;">40%</td>
                        </tr>
                        <tr>
                            <td>scraped_data 크기</td>
                            <td>1.5GB</td>
                            <td>500MB</td>
                            <td style="color: #2ed573;">66%</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        function showTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabId).classList.add('active');
            event.target.classList.add('active');
        }
    </script>
</body>
</html>
